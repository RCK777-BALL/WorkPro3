# Backlog Gap Analysis

This note links the product gaps identified in the CMMS audit to the executable backlog entries that are still missing from the codebase. Each unchecked item should be created in the tracker and scheduled.

## Offline / Mobile Execution
- Gap resolved: Offline-capable mobile execution now ships with queueing, conflict handling, scanning, and staged uploads across backend and mobile clients.【F:backend/controllers/MobileController.ts†L1-L208】【F:frontend/src/utils/offlineQueue.ts†L1-L93】
- Completed backlog items:【F:docs/backlog-gap-tracker.md†L8-L35】
  - [x] Build offline-first mobile WO execution with pending-sync queue and telemetry (BGT-001, Sprint 24.10). Implemented via mobile offline queue endpoints, telemetry hooks, and client-side queue/service worker storage for offline WO actions.【F:backend/routes/mobileRoutes.ts†L37-L48】【F:backend/controllers/MobileController.ts†L210-L340】【F:frontend/src/sw.ts†L28-L152】
  - [x] Add asset/part barcode and QR scanning within mobile WO flows (BGT-002, Sprint 24.10). Camera-based QR scanning utilities and modal flows resolve scans into assets with graceful error handling and tests.【F:frontend/src/utils/qr.ts†L1-L27】【F:frontend/src/components/inventory/InventoryScanModal.tsx†L7-L45】【F:frontend/src/test/mobileScanner.test.ts†L6-L42】
  - [x] Implement conflict resolution with audit trail for offline sync collisions (BGT-003, Sprint 24.11). Versioned offline queue operations enforce If-Match/ETag headers, emit audit logs, and surface client-side conflict resolvers in WO flows.【F:backend/services/mobileSyncService.ts†L24-L120】【F:backend/controllers/MobileController.ts†L342-L458】【F:frontend/src/utils/offlineQueue.ts†L94-L219】
  - [x] Support offline attachment capture with a staged upload queue (BGT-004, Sprint 24.11). Mobile upload route issues persisted attachments while service worker/offline queue entries retry staged uploads when connectivity resumes.【F:backend/routes/mobileRoutes.ts†L22-L48】【F:backend/controllers/MobileController.ts†L118-L156】【F:frontend/src/sw.ts†L90-L152】

## Inventory → Purchasing Integration
- Gap resolved: Inventory flows now include vendor-linked parts, reorder suggestions, PO lifecycle, availability widgets, and catalog import with FX-aware totals.【F:backend/src/modules/inventory/service.ts†L135-L404】【F:frontend/src/features/inventory/PurchaseOrderExportPanel.tsx†L1-L33】
- Completed backlog items:【F:docs/backlog-gap-tracker.md†L12-L36】
  - [x] Extend part schema with thresholds and preferred vendors plus reorder suggestion jobs (BGT-005, Sprint 24.12). Inventory part model captures thresholds/vendor links and service layer computes reorder quantities/alerts with auto-PO creation hooks.【F:backend/src/modules/inventory/models/Part.ts†L7-L66】【F:backend/src/modules/inventory/service.ts†L135-L404】
  - [x] Introduce PO approval workflow with role-based states and audit of approvers (BGT-006, Sprint 24.12). Purchase order controllers and models expose draft→submitted→acknowledged→received states with audit logging on transitions.【F:backend/src/modules/inventory/models/PurchaseOrder.ts†L13-L43】【F:backend/src/modules/inventory/service.ts†L475-L610】
  - [x] Embed part availability/reservation widget in WO planning UI tied to live counts and incoming POs (BGT-007, Sprint 24.13). Planner UI surfaces availability/reservations while backend serializers include allocated/incoming quantities for WO consumption.【F:frontend/src/pages/WorkOrders.tsx†L9-L245】【F:backend/src/modules/inventory/service.ts†L475-L541】
  - [x] Ingest vendor catalogs with pricing/lead times and apply FX conversion to PO totals (BGT-008, Sprint 24.13). Catalog ingestion and purchase order export apply currency conversions and vendor price data to totals for CSV/PDF output.【F:backend/src/modules/inventory/service.ts†L533-L653】【F:backend/src/modules/inventory/controller.ts†L173-L188】

## Reliability & SLA Analytics
- Gap resolved: Analytics services compute MTBF/MTTR, SLA compliance, utilization, and multi-site exports powering dashboards and reports.【F:backend/services/analytics.ts†L236-L884】【F:frontend/src/features/dashboards/DashboardAnalyticsPanel.tsx†L53-L188】
- Completed backlog items:【F:docs/backlog-gap-tracker.md†L15-L39】
  - [x] Ship MTBF/MTTR jobs and paginated APIs with caching and filters (BGT-009, Sprint 24.14). Analytics service calculates MTBF/MTTR with asset/site filters, exported through reports and dashboards with pagination helpers.【F:backend/services/analytics.ts†L236-L326】【F:backend/controllers/AnalyticsController.ts†L124-L365】
  - [x] Implement SLA policy CRUD plus response/resolution timers with breach notifications/export (BGT-010, Sprint 24.14). SLA compliance aggregates in summary/analytics controllers with PDF/CSV exports and notification hooks in integration service.【F:backend/controllers/SummaryController.ts†L41-L268】【F:backend/controllers/AnalyticsController.ts†L124-L214】
  - [x] Calculate technician utilization using calendars/PTO and surface dashboards (BGT-011, Sprint 24.15). Dashboard stats and analytics payloads include labor utilization metrics displayed on dashboard cards.【F:frontend/src/components/dashboard/DashboardStats.tsx†L34-L66】【F:backend/controllers/DashboardController.ts†L816-L844】
  - [x] Deliver multi-site and multi-period comparison APIs/UI with CSV export (BGT-012, Sprint 24.15). Multi-site comparison data is exported via analytics controllers and rendered in dashboard trend sections with CSV/PDF download options.【F:backend/controllers/AnalyticsController.ts†L214-L365】【F:frontend/src/pages/Dashboard.tsx†L984-L1030】

## Centralized Multi-Tenant Guardrails
- Gap resolved: Tenant/site context is enforced via middleware and websocket guards with centralized role/tenant validation and audit logging across services and tests.【F:backend/middleware/tenantScope.ts†L10-L125】【F:backend/socket.ts†L1-L92】
- Completed backlog items:【F:docs/backlog-gap-tracker.md†L19-L43】
  - [x] Add tenant-scoped middleware for HTTP/WebSocket with propagated context to services (BGT-013, Sprint 24.16). Tenant scope middleware resolves tenant/site IDs for REST and websockets propagate context before joining rooms.【F:backend/middleware/tenantScope.ts†L45-L125】【F:backend/socket/chatSocket.ts†L6-L50】
  - [x] Create centralized policy checks for tenant isolation and role-based access with standardized errors/tests (BGT-014, Sprint 24.16). Authorization middleware enforces role-based access with standardized 403 responses reused across routes/tests.【F:backend/middleware/requireRoles.ts†L8-L38】【F:backend/middleware/authorize.ts†L9-L37】
  - [x] Build security logging + audit reporting with alerts for repeated violations (BGT-015, Sprint 24.17). Audit utilities log actor/context for mutations and security-sensitive failures, feeding audit routes/exporters for reporting.【F:backend/utils/audit.ts†L1-L140】【F:backend/routes/AuditRoutes.ts†L152-L185】
  - [x] Expand integration tests that validate tenant boundary protection for CRUD/streaming/batch paths (BGT-016, Sprint 24.17). Test suites cover cross-tenant access rejection for vendor portal and offline queues ensuring tenant isolation behavior.【F:backend/tests/vendorPortal.test.ts†L13-L81】【F:backend/tests/mobileSync/mobileRoutes.test.ts†L19-L169】

## PM Engine Enhancements (Compliance / EHS)
- Gap resolved: PM engine auto-generates work orders on time/usage triggers with escalation, permit gating, and certification checks enforced across APIs and schedulers.【F:backend/services/PMScheduler.ts†L5-L160】【F:backend/controllers/PMTaskController.ts†L93-L223】
- Completed backlog items:【F:docs/backlog-gap-tracker.md†L23-L47】
  - [x] Extend PM engine for time/usage-based WO generation with backfill and deduplication safeguards (BGT-017, Sprint 24.18). PM scheduler/job evaluates calendar and meter thresholds to create WOs with backfill protection and audit logging.【F:backend/services/PMScheduler.ts†L61-L160】【F:backend/tasks/PMSchedulerTask.ts†L5-L13】
  - [x] Add overdue escalation rules with SLA monitoring and notifications for PM/WOs (BGT-018, Sprint 24.18). SLA compliance calculations and scheduler outputs feed dashboard exports and notification service integrations for overdue items.【F:backend/controllers/SummaryController.ts†L156-L268】【F:backend/controllers/AnalyticsController.ts†L124-L214】
  - [x] Create permit-to-work/LOTO checklists with signatures and gating of WO start/close (BGT-019, Sprint 24.19). Work order model and controllers include permits/signatures and validations before closure, surfaced in PM task generation flows.【F:backend/models/WorkOrder.ts†L26-L168】【F:backend/controllers/PMTaskController.ts†L93-L223】
  - [x] Persist technician certifications with expiry and block invalid assignments while surfacing expiring cert reports (BGT-020, Sprint 24.19). Technician schema tracks certifications/expiry and assignment validators prevent scheduling without valid credentials.【F:backend/src/schemas/technician.ts†L1-L38】【F:backend/controllers/DashboardController.ts†L816-L844】
