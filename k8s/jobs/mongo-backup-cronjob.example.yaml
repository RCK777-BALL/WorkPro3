apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongo-backup
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mongodump
              image: mongo:7.0.14
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  apt-get update && apt-get install -y --no-install-recommends awscli ca-certificates && rm -rf /var/lib/apt/lists/*
                  mongodump --uri="$MONGO_URI" --archive=/backup/mongo.archive.gz --gzip
                  aws s3 cp /backup/mongo.archive.gz "s3://${BACKUP_BUCKET}/workpro/$(date +%F)/mongo.archive.gz"
              env:
                - name: MONGO_URI
                  valueFrom:
                    secretKeyRef:
                      name: workpro-app-secrets
                      key: MONGO_URI
                - name: BACKUP_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: workpro-backup-secrets
                      key: BACKUP_BUCKET
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: workpro-backup-secrets
                      key: AWS_ACCESS_KEY_ID
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: workpro-backup-secrets
                      key: AWS_SECRET_ACCESS_KEY
                - name: AWS_DEFAULT_REGION
                  valueFrom:
                    secretKeyRef:
                      name: workpro-backup-secrets
                      key: AWS_DEFAULT_REGION
              volumeMounts:
                - name: backup
                  mountPath: /backup
          volumes:
            - name: backup
              emptyDir: {}
